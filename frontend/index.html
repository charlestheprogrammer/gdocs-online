<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title></title>
  <link rel="stylesheet" href="./index.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" />

  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/client.js"></script>
  <div id="g_id_onload" data-client_id="636019742869-f3msdnme8j56qbfpnincnbgact3n1hkt.apps.googleusercontent.com"
    data-callback="onSignIn">
  </div>
</head>

<body>
  <div class="modal">
    <div class="g_id_signin" data-type="standard"></div>
  </div>
  <div class="openModal" style="display: none" onclick="closeOpenModal()">
    <div class="content">
      <h1>Ouvrez un fichier</h1>
      <ul id="availableFiles"></ul>
    </div>
  </div>
  <header>
    <div>
      <img src="./assets/gdocs.png" alt="" />
      <div>
        <div>
          <input type="text" id="document_title" class="document_title" />
          <div class="items">
            <button id="new">Nouveau</button>
            <button id="save">Enregistrer</button>
            <button id="open">Ouvrir</button>
            <p id="temp_info"></p>
          </div>
        </div>
      </div>
    </div>
    <div id="connected_users">
      <div>
        <img id="user_profile_image" src="" alt="" />
        <p id="user_name"></p>
      </div>
    </div>
  </header>
  <div class="toolbar">
    <select id="formatBlock" class="adv-option-button">
      <option value="H1">H1</option>
      <option value="H2">H2</option>
      <option value="H3">H3</option>
      <option value="H4">H4</option>
      <option value="H5">H5</option>
      <option value="H6">H6</option>
    </select>

    <!-- Font -->
    <select id="fontName" class="adv-option-button"></select>
    <select id="fontSize" class="adv-option-button"></select>

    <!-- Color -->
    <div class="input-wrapper">
      <input type="color" id="foreColor" class="colors-option-button" />
      <button>
        <label for="foreColor"><i class="fa-solid fa-a"></i></label>
      </button>
    </div>
    <div class="input-wrapper">
      <input type="color" id="backColor" class="colors-option-button" />
      <button>
        <label for="backColor"><i class="fa-solid fa-highlighter"></i></label>
      </button>
    </div>
    <button id="bold" class="option-button format">
      <i class="fa-solid fa-bold"></i>
    </button>
    <button id="italic" class="option-button format">
      <i class="fa-solid fa-italic"></i>
    </button>
    <button id="underline" class="option-button format">
      <i class="fa-solid fa-underline"></i>
    </button>
    <button id="strikethrough" class="option-button format">
      <i class="fa-solid fa-strikethrough"></i>
    </button>
    <button id="superscript" class="option-button script">
      <i class="fa-solid fa-superscript"></i>
    </button>
    <button id="subscript" class="option-button script">
      <i class="fa-solid fa-subscript"></i>
    </button>
    <button id="justifyLeft" class="option-button format">
      <i class="fa-solid fa-align-left"></i>
    </button>
    <button id="justifyCenter" class="option-button format">
      <i class="fa-solid fa-align-center"></i>
    </button>
    <button id="justifyRight" class="option-button format">
      <i class="fa-solid fa-align-right"></i>
    </button>
    <input type="file" name="import_image" id="import_image" class="option-button" />
    <div class="input-wrapper">
      <label for="import_image">
        <i class="fa-solid fa-image"></i>
      </label>
    </div>
  </div>
  <div class="page_holder">
    <div class="page" id="page_holder">
      <div name="" id="page-content" contenteditable="true" tabindex="0"></div>
      <div class="users_cursors"></div>
      <div id="selection-preview"></div>
    </div>
  </div>

  <script src="./scripts/toolbar.js"></script>
  <script src="./scripts/collaboration.js"></script>

  <script>
    let document_title = "Document sans titre";
    let cursor_pos = 0;

    function updateTitle() {
      document.getElementById("document_title").value = document_title;
      document.title = document_title + " - Cheetah Docs";
    }

    function updateContent() {
      document_content = document_content_element.value;
      socket.send(
        JSON.stringify({
          type: "updateDocument",
          username: localStorage.getItem("username"),
          document: localStorage.getItem("idDocument"),
          content: document_content_element.innerHTML,
        })
      );
    }

    function setTitle() {
      console.log(window.getSelection().type);
    }

    function closeOpenModal() {
      let openModal = document.querySelector(".openModal");
      openModal.style.display = "none";
    }

    function onSignIn(response) {
      console.log(response);
      if (response.credential) {
        gapi.client.request({
          path: 'https://www.googleapis.com/oauth2/v3/tokeninfo',
          params: { id_token: response.credential },
          callback: function (infoResponse) {
            console.log(infoResponse);
            var userName = infoResponse.name;
            var userProfileImage = infoResponse.picture;

            fetch("http://localhost:3000/api/login", {
              body: JSON.stringify({
                username: userName,
                image_url: userProfileImage
              }),
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
            }).then((res) => {
              let modal = document.querySelector(".modal");
              modal.style.display = "none";
              localStorage.setItem("username", userName);
              localStorage.setItem("user_profile_image", userProfileImage);
              document.getElementById("user_name").innerHTML = localStorage.getItem("username");
              document.getElementById("user_profile_image").src = localStorage.getItem("user_profile_image");
            }).catch((err) => {
              console.log(err);
            });
          }
        });
      } else {
        console.error('Erreur lors de la récupération des informations de profil.');
      }
    }

    Array.from(document.querySelectorAll("[contenteditable]")).forEach(
      function (element, index, array) {
        element.addEventListener("input", function (event) {
          updateContent();
        });
      }
    );

    window.onload = () => {
      document_content_element.focus();
      if (localStorage.getItem("username") != null) {
        let modal = document.querySelector(".modal");
        modal.style.display = "none";
        document.getElementById("user_name").innerHTML =
          localStorage.getItem("username");
      }
      if (localStorage.getItem("idDocument") != null) {
        openFile(localStorage.getItem("idDocument"));
      }
      updateTitle();
    };
  </script>
</body>

</html>